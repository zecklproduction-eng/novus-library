{% extends "base.html" %}
{% block title %}Customization | NOVUS{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 30px auto; padding: 0 20px;">
  
  <div class="cyberpunk-glass-container">
    <h2 class="mb-5" style="color: #fff; font-size: 2rem; font-weight: 400; letter-spacing: 1px;">
      Customization Upload
    </h2>
    
    <!-- Top Row: Main Animations -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 40px; margin-bottom: 50px;">
      
      <!-- Manga Entering Animation -->
      <div class="cyberpunk-card">
        <h5 class="mb-3">Manga Entering Animation</h5>
        
        <!-- Preview -->
        <div id="mangaEnterPreview" class="cyberpunk-preview mb-3">
          {% if active_animations.get('manga_enter') %}
            {% set ext = active_animations['manga_enter'].path.split('.')[-1].lower() %}
            {% if ext in ['mp4', 'webm'] %}
              <video src="{{ url_for('static', filename=active_animations['manga_enter'].path) }}" autoplay loop muted style="width: 100%; height: 100%; object-fit: cover;"></video>
            {% elif ext == 'gif' %}
              <img src="{{ url_for('static', filename=active_animations['manga_enter'].path) }}" style="width: 100%; height: 100%; object-fit: cover;" />
            {% endif %}
          {% else %}
            <img src="{{ url_for('static', filename='img/manga_enter_default.png') }}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.9;" />
          {% endif %}
        </div>
        
        <!-- Dropdown & Upload -->
        <div style="display: flex; gap: 10px;">
          <select id="mangaEnterSelect" class="cyberpunk-select" style="flex: 1;">
            <option value="">Select Animation</option>
            <option value="default" {% if not active_animations.get('manga_enter') %}selected{% endif %}>Default (Power Up)</option>
            {% for anim in animations.manga_enter %}
              <option value="{{ anim.id }}" data-path="{{ anim.path }}" {% if anim.is_active %}selected{% endif %}>Custom #{{ loop.index }}</option>
            {% endfor %}
          </select>
          
          <input type="file" id="mangaEnterUpload" hidden accept=".mp4,.webm,.gif" onchange="uploadAnimation('manga_enter', this)">
          <button onclick="document.querySelector('#mangaEnterUpload').click()" style="background: rgba(102, 126, 234, 0.2); border: 1px solid rgba(102, 126, 234, 0.4); color: #fff; border-radius: 8px; width: 42px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(102, 126, 234, 0.4)'" onmouseout="this.style.background='rgba(102, 126, 234, 0.2)'">
            <i class="fas fa-upload"></i>
          </button>
        </div>
      </div>

      <!-- Log Out Animation -->
      <div class="cyberpunk-card">
        <h5 class="mb-3">Log Out Animation</h5>
        
        <!-- Preview -->
        <div id="logoutPreview" class="cyberpunk-preview mb-3">
          {% if active_animations.get('logout') %}
            {% set ext = active_animations['logout'].path.split('.')[-1].lower() %}
            {% if ext in ['mp4', 'webm'] %}
              <video src="{{ url_for('static', filename=active_animations['logout'].path) }}" autoplay loop muted style="width: 100%; height: 100%; object-fit: cover;"></video>
            {% elif ext == 'gif' %}
              <img src="{{ url_for('static', filename=active_animations['logout'].path) }}" style="width: 100%; height: 100%; object-fit: cover;" />
            {% endif %}
          {% else %}
             <img src="{{ url_for('static', filename='img/logout_default.png') }}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.9;" />
          {% endif %}
        </div>
        
        <!-- Dropdown & Upload -->
        <div style="display: flex; gap: 10px;">
          <select id="logoutSelect" class="cyberpunk-select" style="flex: 1;">
            <option value="">Select Animation</option>
            <option value="default" {% if not active_animations.get('logout') %}selected{% endif %}>Default</option>
            {% for anim in animations.logout %}
              <option value="{{ anim.id }}" data-path="{{ anim.path }}" {% if anim.is_active %}selected{% endif %}>Custom #{{ loop.index }}</option>
            {% endfor %}
          </select>
          
          <input type="file" id="logoutUpload" hidden accept=".mp4,.webm,.gif" onchange="uploadAnimation('logout', this)">
          <button onclick="document.querySelector('#logoutUpload').click()" style="background: rgba(102, 126, 234, 0.2); border: 1px solid rgba(102, 126, 234, 0.4); color: #fff; border-radius: 8px; width: 42px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(102, 126, 234, 0.4)'" onmouseout="this.style.background='rgba(102, 126, 234, 0.2)'">
            <i class="fas fa-upload"></i>
          </button>
        </div>
      </div>
    
    </div>

    <!-- Dashboard Banner -->
    <div class="cyberpunk-card mb-5">
      <h5 class="mb-3">Dashboard Banner</h5>
      
      <!-- Preview -->
      <div id="bannerPreview" class="cyberpunk-preview mb-3" style="height: 250px;">
        {% if active_animations.get('banner') %}
          {% set ext = active_animations['banner'].path.split('.')[-1].lower() %}
          {% if ext in ['mp4', 'webm'] %}
            <video src="{{ url_for('static', filename=active_animations['banner'].path) }}" autoplay loop muted style="width: 100%; height: 100%; object-fit: cover;"></video>
          {% elif ext in ['gif', 'jpg', 'jpeg', 'png'] %}
            <img src="{{ url_for('static', filename=active_animations['banner'].path) }}" style="width: 100%; height: 100%; object-fit: cover;" />
          {% endif %}
        {% else %}
          <img src="{{ url_for('static', filename='img/banner_default.png') }}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.9;" />
        {% endif %}
      </div>
      
      <!-- Dropdown & Upload -->
      <div style="display: flex; gap: 10px; max-width: 600px;">
        <select id="bannerSelect" class="cyberpunk-select" style="flex: 1;">
          <option value="">Select Banner</option>
          <option value="default" {% if not active_animations.get('banner') %}selected{% endif %}>Default</option>
          {% for anim in animations.banner %}
            <option value="{{ anim.id }}" data-path="{{ anim.path }}" {% if anim.is_active %}selected{% endif %}>
              {% if 'banner_option_novus_blue.png' in anim.path %}Novus Blue Circuit (Animated){% else %}Custom #{{ loop.index }}{% endif %}
            </option>
          {% endfor %}
        </select>
        
        <input type="file" id="bannerUpload" hidden accept=".img,.jpg,.jpeg,.png,.gif,.mp4,.webm" onchange="uploadAnimation('banner', this)">
        <button onclick="document.querySelector('#bannerUpload').click()" style="background: rgba(102, 126, 234, 0.2); border: 1px solid rgba(102, 126, 234, 0.4); color: #fff; border-radius: 8px; width: 42px; display: flex; align-items: center; justify-content: center; transition: all 0.3s;" onmouseover="this.style.background='rgba(102, 126, 234, 0.4)'" onmouseout="this.style.background='rgba(102, 126, 234, 0.2)'">
          <i class="fas fa-upload"></i>
        </button>
      </div>
    </div>

    <!-- My Animations Library -->
    <div class="mb-5">
      <h5 class="mb-3" style="color: #fff; font-weight: 500;">My Animations Library</h5>
      
      <div id="animationsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px;">
        {% set allAnimations = animations.manga_enter + animations.logout + animations.banner %}
        {% for anim in allAnimations %}
          <div class="animation-thumbnail cyberpunk-card p-1" style="cursor: pointer; aspect-ratio: 16/9; overflow: hidden; padding: 4px; position: relative;">
            {% set ext = anim.path.split('.')[-1].lower() %}
            {% if ext in ['mp4', 'webm'] %}
              <video src="{{ url_for('static', filename=anim.path) }}" muted loop style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"></video>
            {% else %}
              <img src="{{ url_for('static', filename=anim.path) }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" />
            {% endif %}
            
            <button onclick="deleteAnimation({{ anim.id }})" style="position: absolute; top: 10px; right: 10px; background: rgba(220, 53, 69, 0.9); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
              <i class="fas fa-trash" style="font-size: 12px;"></i>
            </button>
          </div>
        {% else %}
          <div style="grid-column: 1 / -1; padding: 20px; color: #666; font-style: italic;">
            No custom animations found.
          </div>
        {% endfor %}
        
        <!-- Add New (Generic Trigger) -->
        <div onclick="document.querySelector('#mangaEnterUpload').click()" style="display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px dashed rgba(0, 243, 255, 0.3); border-radius: 12px; cursor: pointer; aspect-ratio: 16/9; background: rgba(0, 243, 255, 0.05); transition: all 0.3s;" onmouseover="this.style.borderColor='var(--neon-cyan)'; this.style.background='rgba(0, 243, 255, 0.1)';" onmouseout="this.style.borderColor='rgba(0, 243, 255, 0.3)'; this.style.background='rgba(0, 243, 255, 0.05)';">
          <i class="fas fa-plus" style="font-size: 2rem; color: var(--neon-cyan); margin-bottom: 8px;"></i>
          <span style="color: var(--neon-cyan); font-size: 0.9rem; font-weight: 600;">Upload New</span>
        </div>
      </div>
    </div>

    <!-- Save Changes Button -->
    <div style="text-align: center; margin-bottom: 20px;">
      <button onclick="saveChanges()" class="btn-neon-save">
        Save Changes
      </button>
    </div>

  </div>
</div>

<style>
.animation-thumbnail video:hover,
.animation-thumbnail img:hover {
  transform: scale(1.05);
  transition: transform 0.3s;
}

.animation-thumbnail:hover {
  border-color: var(--neon-blue);
  box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
}
</style>

<script>
let selectedAnimations = {
  manga_enter: {{ active_animations.get('manga_enter', {}).get('id', 'null') }},
  logout: {{ active_animations.get('logout', {}).get('id', 'null') }},
  banner: {{ active_animations.get('banner', {}).get('id', 'null') }}
};

// Handle dropdown changes
document.getElementById('mangaEnterSelect')?.addEventListener('change', function() {
  if (this.value && this.value !== 'default') {
    selectedAnimations.manga_enter = parseInt(this.value);
    updatePreview('mangaEnterPreview', this.options[this.selectedIndex].dataset.path);
  } else if (this.value === 'default' || this.value === '') {
    selectedAnimations.manga_enter = 'null';
    document.getElementById('mangaEnterPreview').innerHTML = `<img src="/static/img/manga_enter_default.png" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.9;" />`;
  }
});

document.getElementById('logoutSelect')?.addEventListener('change', function() {
  if (this.value && this.value !== 'default') {
    selectedAnimations.logout = parseInt(this.value);
    updatePreview('logoutPreview', this.options[this.selectedIndex].dataset.path);
  } else if (this.value === 'default' || this.value === '') {
    selectedAnimations.logout = 'null';
    document.getElementById('logoutPreview').innerHTML = `<img src="/static/img/logout_default.png" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.9;" />`;
  }
});

document.getElementById('bannerSelect')?.addEventListener('change', function() {
  if (this.value && this.value !== 'default') {
    selectedAnimations.banner = parseInt(this.value);
    updatePreview('bannerPreview', this.options[this.selectedIndex].dataset.path);
  } else if (this.value === 'default' || this.value === '') {
    selectedAnimations.banner = 'null';
    document.getElementById('bannerPreview').innerHTML = `<img src="/static/img/banner_default.png" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.9;" />`;
  }
});
});

function updatePreview(previewId, path) {
  const preview = document.getElementById(previewId);
  const ext = path.split('.').pop().toLowerCase();
  
  if (['mp4', 'webm'].includes(ext)) {
    preview.innerHTML = `<video src="/static/${path}" autoplay loop muted style="width: 100%; height: 100%; object-fit: cover;"></video>`;
  } else {
    preview.innerHTML = `<img src="/static/${path}" style="width: 100%; height: 100%; object-fit: cover;" />`;
  }
}

async function uploadAnimation(type, input) {
  const file = input.files[0];
  if (!file) return;
  
  const formData = new FormData();
  formData.append('animation_file', file);
  formData.append('animation_type', type);
  
  try {
    const response = await fetch('/api/animation/upload', {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      const error = await response.json();
      alert('Upload failed: ' + (error.error || 'Unknown error'));
      return;
    }
    
    const data = await response.json();
    alert('Animation uploaded successfully!');
    location.reload(); // Refresh to show new animation
  } catch (error) {
    console.error('Upload error:', error);
    alert('Failed to upload animation');
  }
}

async function deleteAnimation(id) {
  if (!confirm('Are you sure you want to delete this animation?')) return;
  
  try {
    const response = await fetch(`/api/animation/${id}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) {
      alert('Failed to delete animation');
      return;
    }
    
    alert('Animation deleted successfully!');
    location.reload();
  } catch (error) {
    console.error('Delete error:', error);
    alert('Failed to delete animation');
  }
}

async function saveChanges() {
  // Activate selected animations
  const promises = [];
  
  for (const [type, animId] of Object.entries(selectedAnimations)) {
    if (animId && animId !== 'null') {
      promises.push(
        fetch(`/api/animation/${animId}/activate`, {
          method: 'PUT'
        })
      );
    }
  }
  
  try {
    await Promise.all(promises);
    alert('Settings saved successfully!');
    location.reload();
  } catch (error) {
    console.error('Save error:', error);
    alert('Failed to save settings');
  }
}

// Hover effect for animation thumbnails - play video
document.querySelectorAll('.animation-thumbnail video').forEach(video => {
  const container = video.closest('.animation-thumbnail');
  container.addEventListener('mouseenter', () => video.play());
  container.addEventListener('mouseleave', () => {
    video.pause();
    video.currentTime = 0;
  });
});
</script>
{% endblock %}

