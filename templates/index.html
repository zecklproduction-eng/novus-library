{% extends "base.html" %}
{% block title %}E-library | Dashboard{% endblock %}

{% block content %}
<div class="catalog-page">

  <!-- Hero banner -->
  {% if animations.banner and animations.banner.path and 'banner_option_novus_blue.png' in animations.banner.path %}
    <!-- Animated Banner -->
    <div class="catalog-hero circuit-animated">
      
      <!-- Circuit SVG Base -->
      <svg class="circuit-lines" viewBox="0 0 1920 1080" preserveAspectRatio="xMidYMid slice">
        <path class="circuit-path" d="M0 100 H400 L450 150 H800" style="animation: drawLine 3s ease forwards; stroke-dasharray: 1000; stroke-dashoffset: 1000;"/>
        <path class="circuit-path" d="M1920 200 H1500 L1450 250 H1100" style="animation: drawLine 3s 0.5s ease forwards; stroke-dasharray: 1000; stroke-dashoffset: 1000;"/>
        <path class="circuit-path" d="M0 400 H300 L350 450 H600 L650 400 H900" style="animation: drawLine 3s 1s ease forwards; stroke-dasharray: 1000; stroke-dashoffset: 1000;"/>
        <path class="circuit-path" d="M1920 500 H1600 L1550 550 H1200" style="animation: drawLine 3s 1.5s ease forwards; stroke-dasharray: 1000; stroke-dashoffset: 1000;"/>
        <path class="circuit-path" d="M0 700 H200 L250 750 H500" style="animation: drawLine 3s 2s ease forwards; stroke-dasharray: 1000; stroke-dashoffset: 1000;"/>
        <path class="circuit-path" d="M1920 800 H1700 L1650 850 H1400" style="animation: drawLine 3s 2.5s ease forwards; stroke-dasharray: 1000; stroke-dashoffset: 1000;"/>
        
        <circle class="circuit-dot" cx="400" cy="100" r="4"/>
        <circle class="circuit-dot" cx="800" cy="150" r="4"/>
        <circle class="circuit-dot" cx="1500" cy="200" r="4"/>
        <circle class="circuit-dot" cx="300" cy="400" r="4"/>
        <circle class="circuit-dot" cx="1600" cy="500" r="4"/>
        <circle class="circuit-dot" cx="200" cy="700" r="4"/>
      </svg>
      
      <div class="glow-particle"></div>
      <div class="glow-particle"></div>
      <div class="glow-particle"></div>
      <div class="glow-particle"></div>

      <div class="catalog-hero-inner container">
        <h1 class="catalog-title">NOVUS</h1>
        <p class="catalog-subtitle">A New Way to Read.</p>
      </div>
    </div>
  {% else %}
    <!-- Standard Banner -->
    <div class="catalog-hero">
      <div class="catalog-hero-inner container">
        <h1 class="catalog-title">NOVUS</h1>
        <p class="catalog-subtitle">A New Way to Read.</p>
      </div>
    </div>
  {% endif %}

  <div class="container">

    <!-- Breadcrumb -->
    <nav class="breadcrumb-row">
      <a href="{{ url_for(page_endpoint or 'home') }}">Home</a>
      <span>›</span>
      <a href="{{ url_for(page_endpoint or 'home') }}">Books</a>

      {% if selected_category %}
      <span>›</span>
      <span class="crumb-current">{{ selected_category }}</span>
      {% endif %}
    </nav>

    <div class="content-row">
      <!-- Left: Grid -->
      <div class="grid-col">

        <!-- Grid header -->
        <div class="grid-toolbar">
          <div class="result-count">
            Showing <strong>{{ books|length }}</strong> result{{ books|length != 1 and 's' or '' }}
            {% if selected_category %} in <strong>{{ selected_category }}</strong>{% endif %}
          </div>

          <form method="get" class="sort-form" style="display:flex; gap:8px; align-items:center;">
            <input type="text" name="q" placeholder="Search title or author..." value="{{ search_query or '' }}" class="form-control" style="min-width:200px;">
            <select name="category" class="form-select">
              <option value="">All categories</option>
              {% for cat in categories %}
                <option value="{{ cat }}" {% if cat==selected_category %}selected{% endif %}>{{ cat }}</option>
              {% endfor %}
            </select>
            <button class="btn btn-orange" type="submit">Search</button>
          </form>
        </div>

        <!-- Product grid -->
        <div class="product-grid">
  {% if books %}
  {% for b in books %}
  <div class="product-card">
    {% if b[7] %}  <!-- b[7] is the is_favorited boolean -->
    <div class="favorite-heart-top-right">
      <i class="fas fa-heart text-danger"></i>
    </div>
    {% endif %}
    
    <div class="product-thumb">
      {% if b[6] %}
        <img
          src="{{ url_for('static', filename=b[6]) }}"
          alt="{{ b[1] }} cover"
          class="product-cover-img"
        />
      {% else %}
        <div class="book-icon">
          <i class="fas fa-book-open"></i>
        </div>
      {% endif %}
    </div>

    <div class="product-body">
      <div class="product-title">{{ b[1] }}</div>
      <div class="product-meta text-muted">
        {{ b[2] or 'Unknown Author' }} &nbsp;•&nbsp; {{ b[3] or 'General' }}
      </div>
    </div>

    <div class="product-actions">
      <a href="{{ url_for('view_book', id=b[0]) }}" class="btn btn-orange">
        Read
      </a>

      {% if user_role == 'admin' %}
      <form method="post" action="{{ url_for('watchlist_book', book_id=b[0]) }}">
  <input type="hidden" name="status" value="planned">
  <button class="btn btn-ghost" type="submit">Add to Watchlist</button>
</form>

      {% endif %}
    </div>
  </div>
  {% endfor %}
  {% else %}
          <div class="empty-note">
            No books yet. {% if user_role=='admin' %}<a href="{{ url_for('add_book') }}">Add your first book</a>.{% endif %}
          </div>
  {% endif %}
        </div>

      </div>

      <!-- Right: Sidebar categories -->
      <aside class="sidebar-col">
        <div class="sidebar-card">
          <div class="sidebar-title">Product Categories</div>
          <ul class="category-list">
            <li>
              <a class="{{ ''==selected_category and 'is-active' or '' }}" href="{{ url_for('home') }}">All</a>
            </li>
            {% for cat in categories %}
            <li>
              <a class="{{ cat==selected_category and 'is-active' or '' }}"
                 href="{{ url_for('home') }}?category={{ cat|urlencode }}">{{ cat }}</a>
            </li>
            {% endfor %}
          </ul>
        </div>
      </aside>
    </div>
  </div>
</div>
{% endblock %}
