{% extends "base.html" %}
{% block title %}{{ book[1] }} | NOVUS{% endblock %}

{% block content %}
<div class="reading-page">
  <div class="container mt-3 mb-5">

    <a href="{{ url_for('home') }}" class="reading-back-link">
      <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
    </a>

    <!-- MAIN BOOK PANEL -->
    <div class="section-container reading-hero mt-3">
      <div class="row g-4 align-items-center">
        <!-- Cover -->
      <div class="col-md-4 text-center">
    {% if book[6] %}
        <img
          src="{{ url_for('static', filename=book[6]) }}"
          alt="{{ book[1] }} cover"
          class="img-fluid rounded shadow-sm"
          style="max-height: 260px; object-fit: cover;"
        >
    {% else %}
        <div style="font-size: 100px;">ðŸ“–</div>
    {% endif %}
</div>


        <!-- Text / actions -->
        <div class="col-md-8">
          <h1 class="reading-title">{{ book[1] }}</h1>
          <h4 class="reading-author text-muted mb-2">
            By {{ book[2] or "Unknown Author" }}
          </h4>
          <span class="badge badge-category">{{ book[3] }}</span>
 
          <!-- Description + AI summary -->
          <div class="mt-3">
            <h5>Description</h5>
            <p id="bookDescription">{{ book[7] or 'No description available.' }}</p>

            <div class="mt-2" style="display:flex; gap:8px; align-items:center;">
              <button id="bookAiBtn" class="btn btn-outline-light btn-sm"><i class="fas fa-robot me-2"></i>AI Summary</button>
              <button id="bookAiForceBtn" class="btn btn-outline-light btn-sm" style="display:none">Regenerate</button>
              <button id="bookAiCopy" class="btn btn-ghost btn-sm" style="display:none;">Copy</button>
            </div>

            <div id="bookAiResult" class="mt-3" style="display:none; background: rgba(255,255,255,0.03); padding:12px; border-radius:8px;">
              <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                <strong id="bookAiMeta" style="font-size:12px; color:#ccc;">&nbsp;</strong>
              </div>
              <p id="bookAiText" style="margin:6px 0"></p>
            </div>
            <div id="bookAiSpinner" style="display:none; margin-top:8px;"><small>Generating summaryâ€¦</small></div>
          
            <div class="mt-2" style="display:flex; gap:8px; align-items:center;">
          
              <button id="coverAiBtn" class="btn btn-outline-light btn-sm"><i class="fas fa-image me-2"></i>AI Analyze Cover</button>
          
            </div>
          
            <div id="coverAiResult" class="mt-3" style="display:none; background: rgba(255,255,255,0.03); padding:12px; border-radius:8px;">
          
              <strong>Cover Analysis</strong>
          
              <p id="coverAiText" style="margin:6px 0"></p>
          
            </div>
          
          </div>

          
<!-- Watchlist and Favorites actions -->
<div class="mt-3 d-flex align-items-center gap-2 flex-wrap">
  <span class="text-muted me-2">My List:</span>
  <form method="post" action="{{ url_for('watchlist_book', book_id=book[0]) }}">
    <div class="dropdown">
      <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button"
              data-bs-toggle="dropdown" aria-expanded="false">
        {% if current_status %}
          {{ status_labels.get(current_status, 'Add to List') }}
        {% else %}
          + Add to List
        {% endif %}
      </button>
      <ul class="dropdown-menu dropdown-menu-dark">
        <li>
          <button class="dropdown-item" type="submit" name="status" value="reading">
            Reading
          </button>
        </li>
        <li>
          <button class="dropdown-item" type="submit" name="status" value="on_hold">
            On-Hold
          </button>
        </li>
        <li>
          <button class="dropdown-item" type="submit" name="status" value="planned">
            Plan to Watch
          </button>
        </li>
        <li>
          <button class="dropdown-item" type="submit" name="status" value="dropped">
            Dropped
          </button>
        </li>
        <li>
          <button class="dropdown-item" type="submit" name="status" value="completed">
            Completed
          </button>
        </li>
        {% if current_status %}
        <li><hr class="dropdown-divider"></li>
        <li>
          <button class="dropdown-item text-danger" type="submit" name="status" value="remove">
            Remove from List
          </button>
        </li>
        {% endif %}
      </ul>
    </div>
  </form>

  <!-- Favorite button -->
  <form method="post" action="{{ url_for('favorites_book', book_id=book[0]) }}">
    <button type="submit" class="btn btn-sm {% if is_favorited %}btn-danger{% else %}btn-outline-danger{% endif %}">
      <i class="fas fa-heart {% if not is_favorited %}fa-regular{% else %}fa-solid{% endif %} me-1"></i>
      {% if is_favorited %}Favorited{% else %}Add to Favorites{% endif %}
    </button>
  </form>
</div><br>


          <div class="d-flex flex-wrap gap-2">
            {% if book[4] %}
            <a
              href="{{ url_for('static', filename='books/' + book[4]) }}"
              target="_blank"
              class="btn btn-neon"
            >
              <i class="fas fa-file-pdf me-2"></i>Read E-Book (PDF)
            </a>
            {% else %}
            <button class="btn btn-ghost" disabled>
              <i class="fas fa-file-pdf me-2"></i>No PDF Available
            </button>
            {% endif %}

            {% if book[5] %}
            <a
              href="#audio-player"
              class="btn btn-neon-outline"
            >
              <i class="fas fa-headphones me-2"></i>Jump to Audiobook
            </a>
            {% endif %}
          </div>
        </div>
      </div>

      {% if book[5] %}
      <!-- Audiobook block -->
      <div id="audio-player" class="reading-audio mt-4">
        <label class="text-success mb-2">
          ðŸŽ§ <strong>Audiobook Player</strong>
        </label>
        <audio controls style="width: 100%;">
          <source
            src="{{ url_for('static', filename='audio/' + book[5]) }}"
            type="audio/mpeg"
          />
          Your browser does not support audio.
        </audio>
      </div>
      {% endif %}
    </div>

   {# --- COMMUNITY & DISCOVERY --- #}
<section class="book-community">

  <!-- Title -->
  <div class="bc-main-title">
    <h2>Community &amp; Discovery</h2>
  </div>

  <!-- ===== READER REVIEWS (FULL WIDTH CARD) ===== -->
  <div class="bc-reviews-card">
    <div class="bc-reviews-header">
      <div>
        <h3>Reader Reviews</h3>
        <p class="bc-subtitle">The latest thoughts from NOVUS readers.</p>
      </div>

      {% if review_count %}
      <div class="bc-rating-pill">
        â˜… {{ "%.1f"|format(avg_rating or 0) }}
        <span class="bc-rating-count">
          â€¢ {{ review_count }} review{{ 's' if review_count != 1 else '' }}
        </span>
      </div>
      {% endif %}
    </div>

    <div class="bc-reviews-layout">
      <!-- LEFT: list of reviews -->
      <div class="bc-reviews-list">
        {% if reviews %}
          {% for r in reviews %}
          <article class="bc-review-item" onclick="openUserCard(event, '{{ r[4] }}', {{ r[5] }}, '{{ r[6] or '' }}')" style="cursor: pointer;">
            <div class="bc-review-avatar">
              {{ r[4][0]|upper }}
            </div>
            <div class="bc-review-content">
              <div class="bc-review-topline">
                <span class="bc-review-user">{{ r[4] }}</span>
                <span class="bc-review-stars">
                  {% for _ in range(r[2] or 0) %}â˜…{% endfor %}
                  {% for _ in range(5 - (r[2] or 0)) %}â˜†{% endfor %}
                </span>
              </div>
              <p class="bc-review-text">{{ r[1] }}</p>
              <span class="bc-review-date">
                {{ r[3] or '' }}
              </span>
            </div>
          </article>
          {% endfor %}
        {% else %}
          <p class="bc-empty-state">
            No reviews yet. Be the first to share what you think about this book.
          </p>
        {% endif %}
      </div>

      <!-- RIGHT: leave a comment -->
      <div class="bc-review-form">
        <h4>Leave a comment</h4>

        {% if session.get('user_id') %}
        <form action="{{ url_for('add_review', id=book[0]) }}" method="post">
          <label class="bc-field-label">Your rating</label>
          <select name="rating" class="form-select bc-select">
            <option value="5">â˜…â˜…â˜…â˜…â˜… â€“ Loved it</option>
            <option value="4">â˜…â˜…â˜…â˜…â˜† â€“ Great</option>
            <option value="3">â˜…â˜…â˜…â˜†â˜† â€“ Good</option>
            <option value="2">â˜…â˜…â˜†â˜†â˜† â€“ Meh</option>
            <option value="1">â˜…â˜†â˜†â˜†â˜† â€“ Not for me</option>
          </select>

          <label class="bc-field-label mt-3">Your thoughts</label>
          <textarea
            name="content"
            rows="4"
            class="form-control bc-textarea"
            placeholder="What stood out to you? Characters, pacing, vibes..."
          ></textarea>

          <button type="submit" class="btn btn-orange w-100 mt-3">
            Post review
          </button>
        </form>
        {% else %}
        <p class="bc-login-note">
          <a href="{{ url_for('login') }}">Log in</a> to leave a review and join the discussion.
        </p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ===== TOP RECOMMENDATIONS (FULL-WIDTH STRIP AT BOTTOM) ===== -->
  <div class="bc-top-rec-strip">
    <div class="bc-strip-header">
      <div>
        <h3>Top Recommendations</h3>
        <p class="bc-subtitle">Our weekly picks from the NOVUS universe.</p>
      </div>
    </div>

    <div class="bc-rec-row">
      {% if recommendations and recommendations|length > 0 %}
        {% for rec in recommendations %}
        <div class="bc-rec-card">
          <div class="bc-rec-cover">
            {% if rec[4] %}
            <img
              src="{{ url_for('static', filename=rec[4]) }}"
              alt="{{ rec[1] }} cover"
            />
            {% else %}
            <div style="font-size: 50px;">ðŸ“–</div>
            {% endif %}
          </div>
          <div class="bc-rec-info">
            <div class="bc-rec-title">{{ rec[1] }}</div>
            <div class="bc-rec-meta">{{ rec[3] or 'Category' }}</div>
            <a href="{{ url_for('view_book', id=rec[0]) }}" class="bc-rec-btn">View details</a>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <!-- Static placeholders -->
        <div class="bc-rec-card">
          <div class="bc-rec-cover">
            <div style="font-size: 50px;">ðŸ“–</div>
          </div>
          <div class="bc-rec-info">
            <div class="bc-rec-title">Cyber Samurai Saga</div>
            <div class="bc-rec-meta">Sci-Fi â€¢ Action</div>
            <button class="bc-rec-btn" type="button" disabled>Coming soon</button>
          </div>
        </div>

        <div class="bc-rec-card">
          <div class="bc-rec-cover">
            <div style="font-size: 50px;">ðŸ“–</div>
          </div>
          <div class="bc-rec-info">
            <div class="bc-rec-title">Voyage of Stardust</div>
            <div class="bc-rec-meta">Fantasy â€¢ Adventure</div>
            <button class="bc-rec-btn" type="button" disabled>Coming soon</button>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<script>
const bookAiBtn = document.getElementById('bookAiBtn');
const bookAiForceBtn = document.getElementById('bookAiForceBtn');
const bookAiSpinner = document.getElementById('bookAiSpinner');
const bookAiMeta = document.getElementById('bookAiMeta');

async function fetchBookSummary(force=false){
  const btn = bookAiBtn;
  const text = document.getElementById('bookDescription')?.textContent || '';
  if (!text.trim()) return alert('No description available to summarize.');

  try {
    btn.disabled = true; btn.textContent = 'Generating...';
    bookAiSpinner.style.display = 'inline-block';
    const resp = await fetch('/ai_summary', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: text, max_sentences: 3, item_type: 'book', item_id: {{ book[0] }}, force: force })
    });
    const data = await resp.json();
    if (data.summary) {
      document.getElementById('bookAiText').textContent = data.summary;
      document.getElementById('bookAiResult').style.display = 'block';
      document.getElementById('bookAiCopy').style.display = 'inline-block';
      // show meta
      const model = data.model || 'unknown';
      const cached = data.cached ? ' (cached)' : '';
      bookAiMeta.textContent = `Model: ${model}${cached}`;
      if (data.cached){
        bookAiForceBtn.style.display = 'inline-block';
      } else {
        bookAiForceBtn.style.display = 'none';
      }
      // show toast
      showToast('Summary generated'+(data.cached? ' (cached)':'') , 'success');
    } else {
      alert('No summary returned.');
    }
  } catch (e) {
    console.error(e);
    showToast('Error generating summary', 'danger');
  } finally {
    btn.disabled = false; btn.innerHTML = '<i class="fas fa-robot me-2"></i>AI Summary';
    bookAiSpinner.style.display = 'none';
  }
}

bookAiBtn?.addEventListener('click', function(){ fetchBookSummary(false); });
bookAiForceBtn?.addEventListener('click', function(){ fetchBookSummary(true); });

document.getElementById('bookAiCopy')?.addEventListener('click', function() {
  const txt = document.getElementById('bookAiText')?.textContent || '';
  if (!txt) return;
  navigator.clipboard?.writeText(txt).then(()=>{
    this.textContent = 'Copied'; setTimeout(()=> this.style.display='none', 1200);
  });
});

document.getElementById('coverAiBtn')?.addEventListener('click', async function() {
  const btn = this;
  try {
    btn.disabled = true; btn.textContent = 'Analyzing...';
    const resp = await fetch('/api/book/{{ book[0] }}/cover/analyze', { method: 'POST' });
    const data = await resp.json();
    if (data.success) {
      document.getElementById('coverAiText').textContent = data.analysis;
      document.getElementById('coverAiResult').style.display = 'block';
    } else {
      alert('Error: ' + data.error);
    }
  } catch (e) {
    console.error(e);
    alert('Error analyzing cover');
  } finally {
    btn.disabled = false; btn.innerHTML = '<i class="fas fa-image me-2"></i>AI Analyze Cover';
  }
});
</script>

  </div>
</div>
<!-- USER INTERACTION MODAL -->
<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content bg-dark border-secondary">
      <div class="modal-body text-center pt-4">
        <div class="mb-3 position-relative d-inline-block">
             <div id="modalUserAvatar" class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mx-auto border border-info p-1" style="width: 80px; height: 80px; font-size: 30px; overflow: hidden;">
                <!-- img or text injected via js -->
             </div>
        </div>
        <h5 id="modalUserName" class="text-white mb-1"></h5>
        <p id="modalUserRole" class="text-muted small mb-3">Reader</p>

        <div class="d-grid gap-2">
            <a id="modalProfileLink" href="#" class="btn btn-outline-light btn-sm">
                <i class="fas fa-user-circle me-2"></i>View Profile
            </a>
            {% if session.get('user_id') %}
            <button id="modalReportBtn" class="btn btn-outline-danger btn-sm">
                <i class="fas fa-flag me-2"></i>Report User
            </button>
            {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- REPORT MODAL (Reused/Shared) -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-white">Report User</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small">Why are you reporting <strong id="reportTargetName" class="text-white"></strong>?</p>
        <form id="reportForm">
            <input type="hidden" id="reportTargetId">
            <div class="mb-3">
                <textarea class="form-control bg-black text-white border-secondary" id="reportReason" rows="4" placeholder="Describe the issue..." required></textarea>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Submit Report</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
let userModal;
let reportModal;

document.addEventListener('DOMContentLoaded', function() {
    userModal = new bootstrap.Modal(document.getElementById('userModal'));
    reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
});

function openUserCard(event, username, userId, avatarUrl) {
    if (event) event.stopPropagation(); // prevent triggering other clicks if any

    document.getElementById('modalUserName').textContent = username;
    document.getElementById('modalProfileLink').href = '/u/' + username;
    
    const avatarContainer = document.getElementById('modalUserAvatar');
    if (avatarUrl && avatarUrl !== 'None' && avatarUrl !== '') {
        avatarContainer.innerHTML = `<img src="${avatarUrl}" style="width:100%; height:100%; object-fit:cover;">`;
    } else {
        avatarContainer.innerHTML = username.charAt(0).toUpperCase();
    }

    // Report button setup
    const reportBtn = document.getElementById('modalReportBtn');
    if (reportBtn) {
        reportBtn.onclick = function() {
            userModal.hide();
            setTimeout(() => {
                openReportModal(userId, username);
            }, 500);
        };
    }
    
    userModal.show();
}

function openReportModal(userId, username) {
    document.getElementById('reportTargetId').value = userId;
    document.getElementById('reportTargetName').textContent = username;
    document.getElementById('reportReason').value = '';
    reportModal.show();
}

document.getElementById('reportForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const userId = document.getElementById('reportTargetId').value;
    const reason = document.getElementById('reportReason').value;
    
    try {
        const resp = await fetch('/report_user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ reported_user_id: userId, reason: reason })
        });
        const data = await resp.json();
        
        if (data.success) {
            alert('Report submitted. Thank you.');
            reportModal.hide();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch(e) {
        alert('Network error. Please try again.');
    }
});
</script>
{% endblock %}

