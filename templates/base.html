<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>
      {% block title %}NOVUS | Digital Library{% endblock %}
    </title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Favicon -->
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='img/logo.png') }}"
    />

    <!-- Main app stylesheet -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />

    <style>
      /* Pulsing Loading Bar with Glow */
      .top-loading-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, #00d4ff, #0090ff, #00d4ff);
        background-size: 200% 100%;
        z-index: 10000;
        transform: translateX(-100%) scaleY(1);
        transition: transform 0.3s ease;
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
      }

      .top-loading-bar.show {
        transform: translateX(0) scaleY(1);
        animation: loadingPulse 1.5s ease-in-out infinite;
      }

      .top-loading-bar.page-load {
        transform: translateX(0) scaleY(1);
        animation: pageLoadProgress 3s ease-out forwards;
      }

      @keyframes loadingPulse {
        0% {
          transform: translateX(0) scaleY(1);
          box-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
          height: 4px;
        }
        50% {
          transform: translateX(0) scaleY(1.5);
          box-shadow: 0 0 40px rgba(0, 212, 255, 1);
          height: 6px;
        }
        100% {
          transform: translateX(0) scaleY(1);
          box-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
          height: 4px;
        }
      }

      @keyframes pageLoadProgress {
        0% {
          transform: translateX(-100%) scaleY(1);
          box-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
          height: 4px;
        }
        50% {
          transform: translateX(-20%) scaleY(1.3);
          box-shadow: 0 0 35px rgba(0, 212, 255, 1);
          height: 5px;
        }
        80% {
          transform: translateX(-5%) scaleY(1.5);
          box-shadow: 0 0 40px rgba(0, 212, 255, 1.2);
          height: 6px;
        }
        100% {
          transform: translateX(0) scaleY(1);
          box-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
          height: 4px;
        }
      }

      /* Logout Animation Styles */
      .logout-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(220, 53, 69, 0.9) 0%, rgba(0, 0, 0, 0.95) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.5s ease;
      }

      .logout-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .logout-animation {
        text-align: center;
        color: white;
      }

      .logout-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        animation: logoutPulse 1s ease-in-out infinite;
      }

      .logout-text {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        animation: logoutFadeIn 0.5s ease;
      }

      .logout-subtext {
        font-size: 1rem;
        opacity: 0.8;
        animation: logoutFadeIn 0.8s ease;
      }

      @keyframes logoutPulse {
        0%, 100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      @keyframes logoutFadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* User Interaction Modal */
      .user-interaction-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .user-interaction-modal.show {
        opacity: 1;
        visibility: visible;
      }

      .user-interaction-dialog {
        background: #1e1e1e;
        border: 1px solid #333;
        border-radius: 12px;
        width: 320px;
        max-width: 90vw;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        transform: scale(0.9) translateY(20px);
        transition: all 0.3s ease;
      }

      .user-interaction-modal.show .user-interaction-dialog {
        transform: scale(1) translateY(0);
      }

      .user-interaction-header {
        padding: 20px;
        border-bottom: 1px solid #333;
        text-align: center;
      }

      .user-interaction-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 10px;
        border: 3px solid #00d4ff;
        object-fit: cover;
      }

      .user-interaction-name {
        color: #fff;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .user-interaction-role {
        color: #ccc;
        font-size: 0.9rem;
        margin: 0;
      }

      .user-interaction-body {
        padding: 0;
      }

      .user-interaction-option {
        display: block;
        width: 100%;
        padding: 15px 20px;
        background: none;
        border: none;
        color: #fff;
        text-align: left;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 1px solid #333;
      }

      .user-interaction-option:last-child {
        border-bottom: none;
      }

      .user-interaction-option:hover {
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
      }

      .user-interaction-option.danger:hover {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
      }

      .user-interaction-icon {
        margin-right: 12px;
        width: 18px;
        text-align: center;
      }

      .user-interaction-footer {
        padding: 15px 20px;
        border-top: 1px solid #333;
        text-align: center;
      }

      .user-interaction-close {
        background: #333;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .user-interaction-close:hover {
        background: #555;
      }
    </style>
  </head>

  <body class="{{ body_class|default('') }}">

    <!-- Pulsing Loading Bar with Glow -->
    <div id="topLoadingBar" class="top-loading-bar page-load"></div>

    <!-- SIDEBAR -->
    <div class="sidebar">
      <a href="{{ url_for('home') }}">
        <img
          src="{{ url_for('static', filename='img/logo.png') }}"
          class="sidebar-logo"
          alt="NOVUS Logo"
        />
      </a>

      <div class="nav-links">

  <!-- Dashboard -->
  <a href="{{ url_for('home') }}" class="nav-item">
    <i class="fas fa-home"></i>
    <span class="tooltip-text">Dashboard</span>
  </a>

  <!-- MANGA PORTAL BUTTON (with warp animation) -->
<a href="{{ url_for('manga') }}"
   class="nav-item nav-manga"
   id="nav-manga">
  <i class="fas fa-dragon"></i>
  <span class="tooltip-text">Manga Universe</span>
</a>


  <!-- Add Book (admin + publisher only) -->
  {% if session.get('role') in ['admin', 'publisher'] %}
  <a href="{{ url_for('add_book') }}" class="nav-item">
    <i class="fas fa-upload"></i>
    <span class="tooltip-text">Upload Book</span>
  </a>
  {% endif %}

  <!-- Watchlist -->
  <a href="{{ url_for('watchlist') }}" class="nav-item">
    <i class="fas fa-layer-group"></i>
    <span class="tooltip-text">Watchlist</span>
  </a>

  <!-- Profile -->
  <a href="{{ url_for('profile') }}" class="nav-item">
    <i class="fas fa-user"></i>
    <span class="tooltip-text">My Profile</span>
  </a>

  <!-- My Uploads (admin + publisher only) -->
  {% if session.get('role') in ['admin', 'publisher'] %}
  <a href="{{ url_for('my_uploads') }}" class="nav-item">
    <i class="fas fa-folder-open"></i>
    <span class="tooltip-text">My Uploads</span>
  </a>
  {% endif %}

  <!-- Logout -->
  {% if session.get('user_id') %}
  <a href="#" onclick="handleLogout(event)" class="nav-item nav-item-logout">
    <i class="fas fa-sign-out-alt"></i>
    <span class="tooltip-text">Logout</span>
  </a>
  {% endif %}

</div>


      <div class="sidebar-footer">
        <span class="sidebar-brand-text">NOVUS</span>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <header class="top-header-minimal">
        <div class="logo-text-top">NOVUS</div>

        <div class="d-flex align-items-center">
          <div class="top-menu-links">
  {% if session.get('role') == 'admin' %}
  <a href="/admin/team" class="nav-link-item">Team Admin</a>
<a href="{{ url_for('user_management') }}" class="nav-link-item">User Management</a>
<a href="{{ url_for('admin_reports') }}" class="nav-link-item">Reports</a>
{% endif %}


            <div class="dropdown-nav">
              <button
                class="dropdown-btn"
                type="button"
                onclick="toggleDropdown(this)"
              >
                Help &amp; Info
                <i class="fas fa-arrow-up nav-logo-arrow"></i>
              </button>
              <div class="dropdown-content">
                <a href="{{ url_for('faq') }}">FAQ & Guidelines</a>
                <a href="{{ url_for('about') }}">About</a>
              </div>
            </div>
          </div>

          <!-- About (always visible) -->
          <a href="{{ url_for('about') }}" class="nav-link-item ms-3">
            About
          </a>

          <!-- Top-right CTA: Login / Logout -->
  <!-- Top-right: Profile icon dropdown (or Login button if logged out) -->
{% if session.get('user_id') %}
  <div class="dropdown-nav ms-3 profile-dropdown">
    <button class="profile-menu-btn" type="button" onclick="toggleDropdown(this)" aria-label="Open profile menu">
      {% if user_avatar %}
        <img src="{{ user_avatar }}" alt="Profile" class="profile-avatar-icon" style="width:36px; height:36px; border-radius:50%; object-fit:cover;">
      {% else %}
        <i class="fas fa-user-circle"></i>
      {% endif %}
    </button>

    <div class="dropdown-content profile-dropdown-content">

  <!-- Header - Clean avatar only -->
  <div class="profile-dd-header">
    <div class="profile-dd-avatar {% if session.get('plan') == 'ultimate' %}avatar-ultimate{% endif %}">
      {% if session.get('avatar_url') %}
        <img src="{{ session.get('avatar_url') }}" />
      {% else %}
        <i class="fas fa-user-circle"></i>
      {% endif %}
    </div>
    <div class="profile-dd-info">
      <div class="profile-dd-name">{{ session.get('username') }}</div>
      <div class="profile-dd-role">{{ session.get('role','User')|capitalize }}</div>
      <div class="profile-dd-plan">
        Plan: <strong>{{ session.get('plan','basic')|capitalize }}</strong>
        {% if session.get('plan') == 'ultimate' %}
          <span class="sub-forever">Forever</span>
        {% elif session.get('plan_days_left') is not none %}
          <span class="sub-days">{{ session.get('plan_days_left') }}d left</span>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- PROFILE -->
  <div class="dd-section-title">PROFILE</div>
  <a href="{{ url_for('profile') }}"><i class="fas fa-user"></i> Profile & Settings</a>
  <a href="#" data-bs-toggle="modal" data-bs-target="#editProfileModal">
    <i class="fas fa-pen"></i> Edit Profile
  </a>
  <a href="{{ url_for('settings') }}"><i class="fas fa-shield"></i> Security</a>
  <a href="#" onclick="openAppearanceModal(); return false;"><i class="fas fa-palette"></i> Appearance</a>

  <!-- CONTENT -->
  <div class="dd-section-title">CONTENT</div>
  <a href="{{ url_for('my_uploads') }}"><i class="fas fa-book"></i> My Library</a>
  <a href="{{ url_for('add_book') }}"><i class="fas fa-upload"></i> Upload Book</a>
  <a href="#"><i class="fas fa-clock-rotate-left"></i> Reading History</a>
  <a href="{{ url_for('favorites') }}"><i class="fas fa-heart"></i> Favorites</a>

  <!-- ACCOUNT -->
  <div class="dd-section-title">ACCOUNT</div>
  <a href="#" onclick="toggleNotificationDropdown(this); return false;" class="notification-link">
    <i class="fas fa-bell"></i>
    <span>Notifications</span>
    <span class="notification-badge-small" id="notificationBadge">0</span>
  </a>
  <a href="#" onclick="openBillingModal(); return false;">
  <i class="fas fa-credit-card me-2"></i> Billing & Subscription
</a>

  <a href="#" onclick="openActivityLogModal(); return false;"><i class="fas fa-chart-line"></i> Activity Log</a>

  {% if session.get('role') == 'admin' %}
    <div class="dd-section-title">ADMIN</div>
    <a href="{{ url_for('user_management') }}"><i class="fas fa-users-gear"></i> User Management</a>
    <a href="/admin/team"><i class="fas fa-people-group"></i> Team Admin</a>
    <a href="{{ url_for('admin_system_logs') }}"><i class="fas fa-terminal"></i> System Logs</a>
    <a href="{{ url_for('admin_reports') }}"><i class="fas fa-flag"></i> User Reports</a>
  {% endif %}

  <div class="dropdown-divider"></div>

  <!-- LOGOUT -->
  <a href="#" onclick="handleLogout(event)" class="danger">
    <i class="fas fa-right-from-bracket"></i> Log Out
  </a>
</div>

    <!-- Notification Dropdown (positioned relative to profile dropdown) -->
    <div class="notification-dropdown-content profile-notification-dropdown">
      <div class="notification-dropdown-header">
        <span>Notifications</span>
        <button class="mark-all-read-btn" onclick="markAllNotificationsRead()">Mark all as read</button>
      </div>
      <div class="notification-list" id="notificationList">
        <div class="notification-loading">
          <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>
      </div>
      <div class="notification-dropdown-footer">
        <a href="#" onclick="openActivityLogModal(); return false;" class="view-all-notifications">
          <i class="fas fa-list"></i> View All Activity
        </a>
      </div>
    </div>
  </div>
{% else %}
  <a href="{{ url_for('login') }}" class="cta-button ms-3">
    <i class="fas fa-sign-in-alt me-2"></i>
    Log In
  </a>
{% endif %}
        </div>
      </header>

      <!-- FLASH MESSAGES -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-container" style="margin: 15px 0;">
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show"
                   role="alert"
                   style="background:#222; border:1px solid #444; color:white;">
                {{ message }}
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </div>

    <!-- MANGA WARP OVERLAY -->
    <div id="manga-warp-overlay" class="warp-overlay">
      <div class="warp-core"></div>
      <div class="warp-ring"></div>
      <div class="warp-halo"></div>

      <div class="warp-particles">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
      </div>

      <div class="warp-label">ENTERING MANGA UNIVERSE…</div>
    </div>

    <!-- LOGOUT ANIMATION OVERLAY -->
    <div id="logoutOverlay" class="logout-overlay">
      <div class="logout-animation">
        <div class="logout-icon">
          <i class="fas fa-sign-out-alt"></i>
        </div>
        <div class="logout-text">Logging Out...</div>
        <div class="logout-subtext">See you next time!</div>
      </div>
    </div>

    <!-- USER INTERACTION MODAL -->
    <div id="userInteractionModal" class="user-interaction-modal">
      <div class="user-interaction-dialog">
        <div class="user-interaction-header">
          <img id="userAvatar" src="" alt="User Avatar" class="user-interaction-avatar">
          <div class="user-interaction-name" id="userName">User Name</div>
          <div class="user-interaction-role" id="userRole">Role</div>
        </div>
        <div class="user-interaction-body">
          <button class="user-interaction-option" onclick="visitUserProfile()">
            <i class="fas fa-user user-interaction-icon"></i>
            Visit Profile
          </button>
          <button class="user-interaction-option" onclick="sendMessage()">
            <i class="fas fa-envelope user-interaction-icon"></i>
            Send Message
          </button>
          <button class="user-interaction-option" onclick="reportUser()">
            <i class="fas fa-flag user-interaction-icon"></i>
            Report User
          </button>
          <button class="user-interaction-option danger" onclick="blockUser()">
            <i class="fas fa-ban user-interaction-icon"></i>
            Block User
          </button>
        </div>
        <div class="user-interaction-footer">
          <button class="user-interaction-close" onclick="closeUserInteractionModal()">Close</button>
        </div>
      </div>
    </div>

    <!-- Manga warp trigger -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const mangaLink = document.getElementById("manga-link");
        if (!mangaLink) return;

        mangaLink.addEventListener("click", function (e) {
          e.preventDefault();

          const target = this.dataset.target;
          if (!target) return;

          // restart animation class
          document.body.classList.remove("manga-warp");
          void document.body.offsetWidth;
          document.body.classList.add("manga-warp");

          setTimeout(function () {
            window.location.href = target;
          }, 950); // match CSS animation length
        });
      });
    </script>

    <!-- Bootstrap bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Profile JavaScript -->
    <script src="{{ url_for('static', filename='js/profile.js') }}"></script>
    
    <!-- Appearance Settings JavaScript -->
    <script src="{{ url_for('static', filename='js/appearance.js') }}"></script>

    <!-- MANGA WARP OVERLAY -->
<div id="manga-warp-overlay" class="warp-overlay">
  <div class="warp-core"></div>
  <div class="warp-ring"></div>
  <div class="warp-halo"></div>

  <!-- little particles -->
  <div class="warp-particles">
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
  </div>

  <!-- BIG TEXT IN THE CENTER -->
  <div class="warp-label">ENTERING MANGA UNIVERSE...</div>
</div>

<!-- Activity Log Modal -->
<div class="activity-log-modal" id="activityLogModal" aria-hidden="true">
  <div class="activity-log-backdrop" onclick="closeActivityLogModal()"></div>

  <div class="activity-log-dialog" role="dialog" aria-modal="true" aria-label="Activity log">
    <button class="activity-log-close" onclick="closeActivityLogModal()" aria-label="Close">
      &times;
    </button>

    <div class="activity-log-header">
      <h2>ACTIVITY LOG</h2>
    </div>

    <div class="activity-log-content" id="activityLogContent">
      <div class="activity-loading">
        <i class="fas fa-spinner fa-spin"></i> Loading activities...
      </div>
    </div>

    <div class="activity-log-footer">
      <button class="activity-log-btn-secondary" onclick="closeActivityLogModal()">Close</button>
      <a href="{{ url_for('profile') }}#activity" class="activity-log-btn-primary">VIEW FULL HISTORY</a>
    </div>
  </div>
</div>

    <!-- Billing / Subscription Modal -->
<div class="billing-modal" id="billingModal" aria-hidden="true">
  <div class="billing-backdrop" onclick="closeBillingModal()"></div>

  <div class="billing-dialog" role="dialog" aria-modal="true" aria-label="Billing and subscription">
    <button class="billing-close" onclick="closeBillingModal()" aria-label="Close">
      &times;
    </button>

    <div class="billing-header">
      <h2>UNLOCK PREMIUM AI FEATURES</h2>
      <p>Upgrade for an enhanced reading experience.</p>
    </div>

    <div class="billing-grid">
      <!-- Basic -->
      <div class="plan-card {% if session.get('plan') == 'basic' %}plan-current{% endif %}">
        <div class="plan-card-header">
          <div class="plan-title">Basic</div>
          {% if session.get('plan') == 'basic' %}
            <div class="plan-current-badge">
              <i class="fas fa-check-circle"></i> Your Plan
            </div>
          {% endif %}
        </div>
        <div class="plan-details">
          <div class="plan-badge">Free</div>
          <ul class="plan-features">
            <li>✓ Ad-Free Reading</li>
            <li>✓ Basic AI Summary</li>
            <li>✓ AI Character Lore</li>
          </ul>
          <div class="plan-price">Free</div>
        </div>
      </div>

      <!-- Pro (Most Popular) -->
      <div class="plan-card plan-featured {% if session.get('plan') == 'pro' %}plan-current{% endif %}">
        <div class="plan-card-header">
          <div class="plan-title">Pro</div>
          <div class="plan-badge-right">
            <div class="plan-ribbon">Most Popular</div>
            {% if session.get('plan') == 'pro' %}
              <div class="plan-current-badge">
                <i class="fas fa-check-circle"></i> Your Plan
              </div>
            {% endif %}
          </div>
        </div>
        <div class="plan-details">
          <ul class="plan-features">
            <li>✓ Basic AI Summary</li>
            <li>✓ Unlimited AI Chapter Analysis</li>
            <li>✓ AI Character Lore</li>
          </ul>
          <div class="plan-price">$4.99<span>/month</span></div>
        </div>
      </div>

      <!-- Ultimate -->
      <div class="plan-card plan-ultimate {% if session.get('plan') == 'ultimate' %}plan-current{% endif %}">
        <div class="plan-card-header">
          <div class="plan-title">Ultimate</div>
          <div class="plan-badge-right">
            {% if session.get('plan') == 'ultimate' %}
              <div class="plan-current-badge">
                <i class="fas fa-check-circle"></i> Your Plan
              </div>
            {% elif session.get('role') == 'admin' %}
              <div class="plan-current-badge plan-admin-badge">
                <i class="fas fa-crown"></i> Admin Access
              </div>
            {% endif %}
          </div>
        </div>
        <div class="plan-details">
          <ul class="plan-features">
            <li>✓ Basic AI Summary</li>
            <li>✓ Unlimited Chapter Analysis</li>
            <li>✓ AI Character Lore</li>
            <li>✓ Offline Access</li>
          </ul>
          <div class="plan-price">$9.99<span>/month</span></div>
        </div>
      </div>
    </div>

    <div class="billing-actions">
      {% if session.get('plan') == 'ultimate' %}
        <div class="ultimate-countdown">
          <i class="fas fa-crown"></i>
          <span>Ultimate Subscription Active</span>
        </div>
      {% elif session.get('plan') == 'pro' %}
        <button class="billing-primary" onclick="startUpgrade('ultimate')">
          Upgrade to Ultimate
        </button>
      {% else %}
        <button class="billing-primary" onclick="startUpgrade('pro')">
          Upgrade Now
        </button>
      {% endif %}
      <button class="billing-secondary" onclick="closeBillingModal()">Close</button>
    </div>
  </div>
</div>

<!-- Payment Method Modal (new) -->
<style>
.payment-method-modal{position:fixed;inset:0;display:none;z-index:6000}
.payment-method-modal.show{display:flex}
.payment-method-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6)}
.payment-method-dialog{position:relative;margin:auto;background:#0b1219;color:#e6f7ff;border:1px solid #1e374a;border-radius:16px;width:min(92vw,720px);max-height:88vh;overflow:auto;box-shadow:0 20px 60px rgba(0,0,0,.6);padding:20px}
.payment-method-title{margin:0 0 10px 0;text-align:center;font-weight:800;letter-spacing:.06em}
.payment-method-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;padding:6px 0}
.payment-option{display:grid;place-items:center;gap:8px;border-radius:14px;border:1px solid #1e374a;background:#0f1720;padding:16px;cursor:pointer;transition:transform .12s ease,border-color .12s ease,box-shadow .12s ease}
.payment-option .payment-logo{width:72px;height:72px;object-fit:contain}
.payment-option span{font-weight:800;color:#e6f7ff;letter-spacing:.03em}
.payment-option:hover{transform:translateY(-1px);border-color:#00d4ff;box-shadow:0 0 0 2px rgba(0,212,255,.08)}
.payment-option.selected{border-color:#00d4ff;box-shadow:0 0 0 2px rgba(0,212,255,.18)}
.payment-method-actions{display:flex;gap:10px;justify-content:center;margin-top:16px}
.payment-method-primary{background:#00d4ff;color:#001018;border:none;border-radius:10px;padding:10px 18px;font-weight:800;cursor:pointer}
.payment-method-secondary{background:#15202b;color:#e6f7ff;border:1px solid #1e374a;border-radius:10px;padding:10px 18px;font-weight:700;cursor:pointer}
.payment-method-close{position:absolute;top:10px;right:12px;background:transparent;border:none;color:#e6f7ff;font-size:24px;cursor:pointer}
@media(max-width:520px){.payment-option .payment-logo{width:64px;height:64px}}
</style>
<div id="paymentMethodModal" class="payment-method-modal" aria-hidden="true">
  <div class="payment-method-backdrop" onclick="closePaymentMethodModal()"></div>
  <div class="payment-method-dialog" role="dialog" aria-modal="true" aria-label="Select payment method">
    <button class="payment-method-close" onclick="closePaymentMethodModal()" aria-label="Close">&times;</button>
    <h3 class="payment-method-title">Select Payment Method</h3>
    <div class="payment-method-grid" style="grid-template-columns:repeat(3,1fr)">
      <button class="payment-option" id="pm-esewa" onclick="selectPaymentMethod('esewa')">
        <img src="{{ url_for('static', filename='img/esewa_logo.png') }}" alt="eSewa" class="payment-logo" />
        <span>eSewa</span>
      </button>
      <button class="payment-option" id="pm-khalti" onclick="selectPaymentMethod('khalti')">
        <img src="{{ url_for('static', filename='img/khalti.png') }}" alt="Khalti" class="payment-logo" />
        <span>Khalti</span>
      </button>
      <button class="payment-option" id="pm-card" onclick="selectPaymentMethod('card')">
        <i class="fas fa-credit-card payment-logo" aria-hidden="true"></i>
        <span>Credit / Debit Card</span>
      </button>
    </div>
    <div class="payment-method-actions">
      <button class="payment-method-primary" onclick="confirmPayment()">Confirm</button>
      <button class="payment-method-secondary" onclick="closePaymentMethodModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Appearance Modal -->
<div class="appearance-modal" id="appearanceModal" aria-hidden="true">
  <div class="appearance-backdrop" onclick="closeAppearanceModal()"></div>
  
  <div class="appearance-dialog" role="dialog" aria-modal="true" aria-label="Appearance settings">
    <button class="appearance-close" onclick="closeAppearanceModal()" aria-label="Close">
      &times;
    </button>

    <div class="appearance-header">
      <h2><i class="fas fa-palette"></i> Appearance Settings</h2>
      <p>Customize your reading experience</p>
    </div>

    <div class="appearance-content">
      <!-- Theme Selection -->
      <div class="appearance-section">
        <h3><i class="fas fa-paint-brush"></i> Theme</h3>
        <div class="theme-options">
          <div class="theme-option active" data-theme="dark" data-action="selectTheme">
            <div class="theme-preview dark-theme-preview"></div>
            <span>Dark</span>
          </div>
          <div class="theme-option" data-theme="light" data-action="selectTheme">
            <div class="theme-preview light-theme-preview"></div>
            <span>Light</span>
          </div>
          <div class="theme-option" data-theme="blue" data-action="selectTheme">
            <div class="theme-preview blue-theme-preview"></div>
            <span>Ocean Blue</span>
          </div>
          <div class="theme-option" data-theme="purple" data-action="selectTheme">
            <div class="theme-preview purple-theme-preview"></div>
            <span>Royal Purple</span>
          </div>
        </div>
      </div>

      <!-- Font Size -->
      <div class="appearance-section">
        <h3><i class="fas fa-text-height"></i> Font Size</h3>
        <div class="font-size-options">
          <button class="font-size-btn" data-size="small" data-action="selectFontSize">
            <span class="font-size-sample small">Aa</span>
            <small>Small</small>
          </button>
          <button class="font-size-btn active" data-size="medium" data-action="selectFontSize">
            <span class="font-size-sample medium">Aa</span>
            <small>Medium</small>
          </button>
          <button class="font-size-btn" data-size="large" data-action="selectFontSize">
            <span class="font-size-sample large">Aa</span>
            <small>Large</small>
          </button>
          <button class="font-size-btn" data-size="xlarge" data-action="selectFontSize">
            <span class="font-size-sample xlarge">Aa</span>
            <small>Extra Large</small>
          </button>
        </div>
      </div>

      <!-- Layout Density -->
      <div class="appearance-section">
        <h3><i class="fas fa-th"></i> Layout Density</h3>
        <div class="density-options">
          <button class="density-btn" data-density="compact" data-action="selectDensity">
            <div class="density-preview compact"></div>
            <small>Compact</small>
          </button>
          <button class="density-btn active" data-density="comfortable" data-action="selectDensity">
            <div class="density-preview comfortable"></div>
            <small>Comfortable</small>
          </button>
          <button class="density-btn" data-density="spacious" data-action="selectDensity">
            <div class="density-preview spacious"></div>
            <small>Spacious</small>
          </button>
        </div>
      </div>

      <!-- Accent Color -->
      <div class="appearance-section">
        <h3><i class="fas fa-palette"></i> Accent Color</h3>
        <div class="accent-options">
          <button class="accent-option active" data-color="cyan" data-action="selectAccentColor" style="background: linear-gradient(135deg, #00d4ff, #0090ff)">
            <span class="accent-check">✓</span>
          </button>
          <button class="accent-option" data-color="purple" data-action="selectAccentColor" style="background: linear-gradient(135deg, #667eea, #764ba2)">
            <span class="accent-check">✓</span>
          </button>
          <button class="accent-option" data-color="pink" data-action="selectAccentColor" style="background: linear-gradient(135deg, #ff9a9e, #fecfef)">
            <span class="accent-check">✓</span>
          </button>
          <button class="accent-option" data-color="green" data-action="selectAccentColor" style="background: linear-gradient(135deg, #56ab2f, #a8e6cf)">
            <span class="accent-check">✓</span>
          </button>
          <button class="accent-option" data-color="orange" data-action="selectAccentColor" style="background: linear-gradient(135deg, #ff6b35, #f7931e)">
            <span class="accent-check">✓</span>
          </button>
        </div>
      </div>

      <!-- Reading Preferences -->
      <div class="appearance-section">
        <h3><i class="fas fa-book-open"></i> Reading Preferences</h3>
        <div class="reading-preferences">
          <label class="preference-toggle">
            <input type="checkbox" id="toggleSmoothScroll" data-action="toggleSmoothScroll">
            <span class="toggle-slider"></span>
            <span class="toggle-label">Smooth scrolling</span>
          </label>
          <label class="preference-toggle">
            <input type="checkbox" id="togglePageTransitions" data-action="togglePageTransitions" checked>
            <span class="toggle-slider"></span>
            <span class="toggle-label">Page transitions</span>
          </label>
          <label class="preference-toggle">
            <input type="checkbox" id="toggleAnimations" data-action="toggleAnimations" checked>
            <span class="toggle-slider"></span>
            <span class="toggle-label">Animations</span>
          </label>
        </div>
      </div>
    </div>

    <div class="appearance-footer">
      <div class="appearance-actions">
        <button class="appearance-btn secondary" data-action="resetToDefaults">
          <i class="fas fa-undo"></i> Reset to Defaults
        </button>
        <div class="appearance-main-actions">
          <button class="appearance-btn secondary" data-action="closeAppearanceModal">Cancel</button>
          <button class="appearance-btn primary" data-action="saveAppearanceSettings">
            <i class="fas fa-save"></i> Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function openBillingModal() {
    document.getElementById("billingModal").classList.add("show");
    document.body.classList.add("no-scroll");
  }
  function closeBillingModal() {
    document.getElementById("billingModal").classList.remove("show");
    document.body.classList.remove("no-scroll");
  }
  function openPaymentMethodModal() {
    document.getElementById("paymentMethodModal").classList.add("show");
    document.body.classList.add("no-scroll");
  }
  function closePaymentMethodModal() {
    document.getElementById("paymentMethodModal").classList.remove("show");
    document.body.classList.remove("no-scroll");
  }
  function startUpgrade(plan) {
    window._selectedPlan = plan;
    // reset selection state
    window._selectedMethod = null;
    var es = document.getElementById('pm-esewa');
    var kh = document.getElementById('pm-khalti');
    if (es) es.classList.remove('selected');
    if (kh) kh.classList.remove('selected');
    openPaymentMethodModal();
  }
  function selectPaymentMethod(method) {
    window._selectedMethod = method;
    var es = document.getElementById('pm-esewa');
    var kh = document.getElementById('pm-khalti');
    var cc = document.getElementById('pm-card');
    if (es) es.classList.toggle('selected', method === 'esewa');
    if (kh) kh.classList.toggle('selected', method === 'khalti');
    if (cc) cc.classList.toggle('selected', method === 'card');
  }
  function confirmPayment() {
    var plan = window._selectedPlan || 'pro';
    var method = window._selectedMethod;
    if (!method) {
      // nudge: default highlight eSewa if nothing chosen
      var es = document.getElementById('pm-esewa');
      if (es) es.classList.add('selected');
      return;
    }
    closePaymentMethodModal();
    if (method === 'esewa') {
      window.location.href = `/pay/esewa/initiate?plan=${encodeURIComponent(plan)}`;
    } else if (method === 'khalti') {
      window.location.href = `/pay/khalti/initiate?plan=${encodeURIComponent(plan)}`;
    } else if (method === 'card') {
      // placeholder route; implement server route if needed
      window.location.href = `/pay/card/initiate?plan=${encodeURIComponent(plan)}`;
    }
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const link = document.getElementById("manga-link");
    if (!link) return;

    link.addEventListener("click", function (e) {
      e.preventDefault();

      const target = this.dataset.target || this.getAttribute("href");

      // restart animation each time
      document.body.classList.remove("manga-warp");
      void document.body.offsetWidth; // force reflow
      document.body.classList.add("manga-warp");

      // let the portal play, then go to /manga
      setTimeout(function () {
        window.location.href = target;
      }, 1100); // 1.1s, slightly longer than the CSS keyframes
    });
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const mangaLink = document.getElementById("nav-manga");
    const overlay   = document.getElementById("manga-warp-overlay");

    if (!mangaLink || !overlay) return;

    mangaLink.addEventListener("click", function (e) {
      e.preventDefault(); // play animation first

      overlay.classList.add("show");
      document.body.classList.add("manga-warp"); // for background dim / blur

      // Duration should roughly match your CSS animation (~900ms)
      setTimeout(() => {
        window.location.href = this.href;
      }, 900);
    });
  });
</script>

    <!-- Dropdown + delete helper -->
    <script>
      function toggleDropdown(button) {
        const dropdown = button.closest(".dropdown-nav");
        const content = dropdown.querySelector(".dropdown-content");
        const arrow   = dropdown.querySelector(".nav-logo-arrow");

        const isOpen = content.style.display === "block";

        // Close all dropdowns
        document.querySelectorAll(".dropdown-content").forEach(el => {
          el.style.display = "none";
        });
        document.querySelectorAll(".nav-logo-arrow").forEach(el => {
          el.style.transform = "translateY(2px) rotate(180deg)";
        });

        // Open this one if it was closed
        if (!isOpen) {
          content.style.display = "block";
          arrow.style.transform = "translateY(2px) rotate(0deg)";
        }
      }

      function confirmDelete() {
        return confirm("Are you sure you want to permanently delete this book?");
      }
    </script>

    <!-- Activity Log Modal Functions -->
    <script>
      function openActivityLogModal() {
        const modal = document.getElementById("activityLogModal");
        modal.classList.add("show");
        document.body.classList.add("no-scroll");
        loadActivityLog();
      }

      function closeActivityLogModal() {
        const modal = document.getElementById("activityLogModal");
        modal.classList.remove("show");
        document.body.classList.remove("no-scroll");
      }

      function loadActivityLog() {
        const contentDiv = document.getElementById("activityLogContent");
        
        fetch("{{ url_for('get_activity_log') }}?limit=5")
          .then(response => response.json())
          .then(activities => {
            if (!activities || activities.length === 0) {
              contentDiv.innerHTML = `
                <div class="activity-empty">
                  <i class="fas fa-inbox"></i>
                  <p>No activities yet</p>
                </div>
              `;
              return;
            }

            let html = '<div class="activity-list">';
            
            activities.forEach(activity => {
              const badgeClass = activity.has_summary ? 'activity-badge-summarized' : '';
              const badgeIcon = activity.has_summary ? '<span class="activity-badge">AI Summarized</span>' : '';
              
              html += `
                <div class="activity-item">
                  <div class="activity-icon">
                    <i class="fas ${activity.icon}"></i>
                  </div>
                  <div class="activity-details">
                    <div class="activity-text">
                      ${activity.type.charAt(0).toUpperCase() + activity.type.slice(1)} 
                      <strong>"${activity.title}"</strong>
                      ${badgeIcon}
                    </div>
                    <div class="activity-time">${activity.when}</div>
                  </div>
                </div>
              `;
            });

            html += '</div>';
            
            // Add reading level bar
            html += `
              <div class="activity-reading-level">
                <div class="reading-level-text">Reading Level: 7 - Chronoscribe</div>
                <div class="reading-level-bar">
                  <div class="reading-level-fill" style="width: 73%"></div>
                </div>
                <div class="reading-level-percent">73%</div>
              </div>
            `;

            contentDiv.innerHTML = html;
          })
          .catch(error => {
            console.error("Error loading activity log:", error);
            contentDiv.innerHTML = `
              <div class="activity-empty">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading activities</p>
              </div>
            `;
          });
      }

      // Close modal when clicking outside
      document.addEventListener("click", function(event) {
        const modal = document.getElementById("activityLogModal");
        const backdrop = document.querySelector(".activity-log-backdrop");
        if (event.target === backdrop) {
          closeActivityLogModal();
        }
      });
    </script>

    <!-- Notification System Functions -->
    <script>
      // Notification dropdown toggle
      function toggleNotificationDropdown(button) {
        const profileDropdown = button.closest(".profile-dropdown");
        const notificationDropdown = profileDropdown.querySelector(".profile-notification-dropdown");
        const isOpen = notificationDropdown.classList.contains("show");
        
        // Close all notification dropdowns
        document.querySelectorAll(".notification-dropdown-content").forEach(el => {
          el.classList.remove("show");
        });
        
        // Close profile dropdown
        document.querySelectorAll(".profile-dropdown-content").forEach(el => {
          el.style.display = "none";
        });
        document.querySelectorAll(".nav-logo-arrow").forEach(el => {
          el.style.transform = "translateY(2px) rotate(180deg)";
        });
        
        // Open this notification dropdown if it was closed
        if (!isOpen) {
          notificationDropdown.classList.add("show");
          loadNotifications();
        }
      }

      // Load notifications
      function loadNotifications() {
        const notificationList = document.getElementById("notificationList");
        
        fetch("{{ url_for('get_activity_log') }}?limit=3")
          .then(response => response.json())
          .then(activities => {
            if (!activities || activities.length === 0) {
              notificationList.innerHTML = `
                <div class="notification-empty">
                  <i class="fas fa-inbox"></i>
                  <p>No notifications yet</p>
                </div>
              `;
              updateNotificationBadge(0);
              return;
            }

            let html = '';
            let unreadCount = 0;
            
            activities.forEach((activity, index) => {
              const isUnread = index < 2; // Mark first 2 as unread for demo
              if (isUnread) unreadCount++;
              
              const badgeClass = activity.has_summary ? 'activity-badge-summarized' : '';
              const badgeIcon = activity.has_summary ? '<span class="activity-badge" style="font-size: 10px; padding: 2px 6px; margin-left: 8px;">AI</span>' : '';
              
              html += `
                <div class="notification-item ${isUnread ? 'unread' : ''}" onclick="markNotificationRead(${activity.id || index})">
                  <div class="notification-icon-small">
                    <i class="fas ${activity.icon}"></i>
                  </div>
                  <div class="notification-content">
                    <div class="notification-text">
                      ${activity.type.charAt(0).toUpperCase() + activity.type.slice(1)} 
                      <strong>"${activity.title}"</strong>
                      ${badgeIcon}
                    </div>
                    <div class="notification-time">${activity.when}</div>
                  </div>
                </div>
              `;
            });

            notificationList.innerHTML = html;
            updateNotificationBadge(unreadCount);
          })
          .catch(error => {
            console.error("Error loading notifications:", error);
            notificationList.innerHTML = `
              <div class="notification-empty">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading notifications</p>
              </div>
            `;
            updateNotificationBadge(0);
          });
      }

      // Update notification badge
      function updateNotificationBadge(count) {
        const badge = document.getElementById("notificationBadge");
        if (badge) {
          if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.classList.add("has-notifications");
          } else {
            badge.textContent = '0';
            badge.classList.remove("has-notifications");
          }
        }
      }

      // Mark notification as read
      function markNotificationRead(notificationId) {
        // For demo purposes, just update the UI
        const notificationItems = document.querySelectorAll('.notification-item.unread');
        if (notificationItems.length > 0) {
          notificationItems[0].classList.remove('unread');
          updateNotificationBadge(notificationItems.length - 1);
        }
      }

      // Mark all notifications as read
      function markAllNotificationsRead() {
        const notificationItems = document.querySelectorAll('.notification-item.unread');
        notificationItems.forEach(item => {
          item.classList.remove('unread');
        });
        updateNotificationBadge(0);
        
        // Show feedback
        const markBtn = document.querySelector('.mark-all-read-btn');
        const originalText = markBtn.textContent;
        markBtn.textContent = 'Marked as read';
        markBtn.style.color = '#4CAF50';
        
        setTimeout(() => {
          markBtn.textContent = originalText;
          markBtn.style.color = 'var(--neon-blue)';
        }, 2000);
      }

      // Close notification dropdown when clicking outside
      document.addEventListener("click", function(event) {
        const notificationContainer = event.target.closest(".notification-container");
        const profileContainer = event.target.closest(".profile-dropdown");
        
        if (!notificationContainer && !profileContainer) {
          document.querySelectorAll(".notification-dropdown-content").forEach(el => {
            el.classList.remove("show");
          });
        }
      });

      // Load notifications on page load
      document.addEventListener("DOMContentLoaded", function() {
        // Load notifications after a short delay
        setTimeout(() => {
          loadNotifications();
        }, 1000);
      });

      // Logout animation function
      function handleLogout(event) {
        event.preventDefault();

        const overlay = document.getElementById('logoutOverlay');
        const topLoadingBar = document.getElementById('topLoadingBar');

        // Show top loading bar
        if (topLoadingBar) {
          topLoadingBar.classList.add('show');
          topLoadingBar.classList.remove('page-load');
        }

        overlay.classList.add('show');

        // Redirect to logout after animation
        setTimeout(() => {
          window.location.href = '{{ url_for("logout") }}';
        }, 2000); // 2 second delay for animation
      }

      // Page load completion handler
      window.addEventListener('load', function() {
        const topLoadingBar = document.getElementById('topLoadingBar');

        // Hide page load loading bar after animation completes
        setTimeout(() => {
          if (topLoadingBar && topLoadingBar.classList.contains('page-load')) {
            topLoadingBar.style.transform = 'translateX(100%) scaleY(0)';
            setTimeout(() => {
              topLoadingBar.style.display = 'none';
            }, 300);
          }
        }, 3000); // Wait for 3 seconds (animation duration)
      });

      // User Interaction Modal Functions
      let currentUserId = null;
      let currentContext = null;

      function openUserInteractionModal(userId, userName, userRole, avatarUrl, event, context = null) {
        event.preventDefault();
        event.stopPropagation();

        // Debug: temporarily show alert
        console.log('Opening modal for user:', userId, userName, context);

        // Don't show modal for current user
        const currentUserId = {{ session.get('user_id') or 'null' }};
        if (userId == currentUserId) {
          console.log('Not showing modal for current user');
          // Temporarily show modal anyway for testing
          // return;
        }

        currentUserId = userId;
        currentContext = context;

        // Update modal content
        document.getElementById('userName').textContent = userName;
        document.getElementById('userRole').textContent = userRole || 'Reader';

        const avatarImg = document.getElementById('userAvatar');
        if (avatarUrl) {
          avatarImg.src = avatarUrl;
        } else {
          avatarImg.src = '{{ url_for("static", filename="img/person.png") }}';
        }

        // Show/hide options based on context
        const allOptions = document.querySelectorAll('.user-interaction-option');
        const sendMessageBtn = document.querySelector('.user-interaction-option .fa-envelope')?.closest('.user-interaction-option');
        const blockUserBtn = document.querySelector('.user-interaction-option.danger');

        if (context === 'review') {
          // Hide send message and block user options for reviews
          if (sendMessageBtn) sendMessageBtn.style.display = 'none';
          if (blockUserBtn) blockUserBtn.style.display = 'none';
        } else {
          // Show all options for other contexts
          allOptions.forEach(option => option.style.display = 'block');
        }

        // Show modal
        document.getElementById('userInteractionModal').classList.add('show');
        document.body.classList.add('no-scroll');
      }

      function closeUserInteractionModal() {
        document.getElementById('userInteractionModal').classList.remove('show');
        document.body.classList.remove('no-scroll');
        currentUserId = null;
        currentContext = null;

        // Reset option visibility
        const allOptions = document.querySelectorAll('.user-interaction-option');
        allOptions.forEach(option => option.style.display = 'block');
      }

      function visitUserProfile() {
        if (currentUserId) {
          window.location.href = `/user/${currentUserId}`;
        }
        closeUserInteractionModal();
      }

      function sendMessage() {
        // Placeholder for messaging functionality
        alert('Messaging feature coming soon!');
        closeUserInteractionModal();
      }

      function reportUser() {
        if (confirm('Are you sure you want to report this user?')) {
          // Log the report
          fetch('/report_user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              reported_user_id: currentUserId,
              reason: 'Inappropriate behavior'
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('User reported successfully. Thank you for your feedback.');
            } else {
              alert('Failed to report user. Please try again.');
            }
          })
          .catch(error => {
            console.error('Error reporting user:', error);
            alert('Failed to report user. Please try again.');
          });
        }
        closeUserInteractionModal();
      }

      function blockUser() {
        if (confirm('Are you sure you want to block this user? You will no longer see their content.')) {
          // Placeholder for blocking functionality
          alert('User blocking feature coming soon!');
        }
        closeUserInteractionModal();
      }

      // Close modal when clicking outside
      document.addEventListener('click', function(event) {
        const modal = document.getElementById('userInteractionModal');
        if (event.target === modal) {
          closeUserInteractionModal();
        }
      });
    </script>
  </body>
</html>
